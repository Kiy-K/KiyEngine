name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  # T√™n binary g·ªëc trong Cargo.toml
  CRATE_BIN_NAME: kiy_engine_v5_alpha
  # T√™n binary mu·ªën xu·∫•t b·∫£n (cho chuy√™n nghi·ªáp)
  RELEASE_BIN_NAME: kiyengine

jobs:
  build:
    name: Build ${{ matrix.target_name }}
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target_name: linux-x86_64
            artifact_name: kiyengine-linux-x86_64
            binary_ext: ""
            archive_ext: ".tar.gz"
            rustflags: "-C target-cpu=x86-64-v3"
          - os: windows-latest
            target_name: windows-x86_64
            artifact_name: kiyengine-windows-x86_64
            binary_ext: ".exe"
            archive_ext: ".zip"
            rustflags: "-C target-cpu=x86-64-v3"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build release
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
        run: cargo build --release

      - name: Strip binary (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: strip target/release/${{ env.CRATE_BIN_NAME }}${{ matrix.binary_ext }}

      - name: Prepare Assets
        run: |
          mkdir -p dist
          # Copy binary ch√≠nh v√† ƒë·ªïi t√™n
          cp target/release/${{ env.CRATE_BIN_NAME }}${{ matrix.binary_ext }} dist/${{ env.RELEASE_BIN_NAME }}${{ matrix.binary_ext }}
          
          # Copy c√°c file ƒëi k√®m (n·∫øu c√≥)
          if [ -f kiyengine.gguf ]; then cp kiyengine.gguf dist/; fi
          if [ -f kiyengine.nnue ]; then cp kiyengine.nnue dist/; fi
          
          # Copy s√°ch khai cu·ªôc (m·ªü r·ªông t√¨m ki·∫øm)
          find . -maxdepth 2 -name "*.bin" -exec cp {} dist/ \;

      - name: Package Archive
        run: |
          cd dist
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            7z a ../${{ matrix.artifact_name }}.zip *
            # Copy ri√™ng file exe ra ngo√†i ƒë·ªÉ upload b·∫£n l·∫ª
            cp ${{ env.RELEASE_BIN_NAME }}${{ matrix.binary_ext }} ../${{ matrix.RELEASE_BIN_NAME }}-windows-standalone.exe
          else
            tar -czvf ../${{ matrix.artifact_name }}.tar.gz *
          fi

      - name: Upload Artifacts to Action
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}${{ matrix.archive_ext }}
            *.exe

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release_assets
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release_assets/*.zip
            release_assets/*.tar.gz
            release_assets/*.exe
          name: KiyEngine ${{ github.ref_name }}
          body: |
            ## üöÄ KiyEngine ${{ github.ref_name }} - "The Assassin"
            
            B·∫£n c·∫≠p nh·∫≠t t·ªëi ∆∞u h√≥a hi·ªáu nƒÉng v√† s·ª≠a l·ªói qu·∫£n l√Ω th·ªùi gian.
            
            ### üì¶ Assets
            - **Windows:** T·∫£i file `.zip` (ƒë·∫ßy ƒë·ªß model/book) ho·∫∑c file `.exe` l·∫ª.
            - **Linux:** D√πng file `.tar.gz`.
            
            ### üõ†Ô∏è Y√™u c·∫ßu ph·∫ßn c·ª©ng
            - CPU h·ªó tr·ª£ **AVX2** (x86-64-v3).
            - Model GGUF 2-bit (Ternary).
          draft: false
          prerelease: false
          generate_release_notes: true